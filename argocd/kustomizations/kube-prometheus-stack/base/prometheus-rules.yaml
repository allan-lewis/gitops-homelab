---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: homelab-ip-anomaly
  namespace: kube-prometheus-stack
  labels:
    release: kube-prometheus-stack 
spec:
  groups:
  - name: homelab.rules
    rules:
    - alert: HomelabPublicIPPatternInvalid
      expr: |
        count(count_values("ip", homelab_public_ip_numeric)) != 2
        or
        min(count_values("ip", homelab_public_ip_numeric)) != 1
      for: 10m
      labels:
        severity: critical
      annotations:
        summary: "Unexpected public IP distribution across homelab nodes"
        description: |
          Expected exactly one node to report a different public IP address.
          This alert fires when all nodes agree or when multiple nodes disagree,
          and persists in that state for at least 10 minutes.
---
apiVersion: monitoring.coreos.com/v1
kind: AlertmanagerConfig
metadata:
  name: telegram-alertmanager-config
  labels:
    alertmanager: config  # This label matches the selector in values.yaml
spec:
  receivers:
    - name: telegram
      telegram_configs:
        - chat_id_file: "/etc/secrets/telegram/chat_id"
          bot_token_file: "/etc/secrets/telegram/bot_token"
          parse_mode: "Markdown"
          message: |
            *Alert:* {{ .CommonAnnotations.summary }}
            {{ range .Alerts }}
              â€¢ *{{ .Labels.alertname }}*: {{ .Annotations.description }}
            {{ end }}

  route:
    receiver: telegram
    group_by: ['alertname']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 12h
