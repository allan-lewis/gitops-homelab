---
- name: Generate k8s manifests for Traefik.
  hosts: localhost
  become: no
  gather_facts: no
  vars:
    gitops_helm_repo_name: "traefik"
    gitops_helm_repo_url: "https://traefik.github.io/charts"
    gitops_helm_chart_ref: "traefik/traefik"
    gitops_helm_chart_version: "34.3.0"
    gitops_service_name: "traefik"
    gitops_helm_namespace: "traefik"

  roles:
    - role: gitops-helm-template
      vars:
        gitops_traefik_load_balancer_ip: "192.168.86.49"
        gitops_output_dir: "../model/traefik/nonprod/"
        gitops_temp_values_location: "/tmp/gitops-homelab/traefik/nonprod"
        gitops_helm_value_files:
          - template: "gitops-traefik-values.yaml.j2"
            dest: "{{ gitops_temp_values_location }}/gitops-traefik-values.yaml"
        # gitops_traefik_routes:
        #   - host: tools.nonprod.allanshomelab.com
    # - role: gitops-helm-template
    #   vars:
    #     gitops_output_dir: "../model/it-tools/production/"
    #     gitops_traefik_routes:
    #       - host: tools.k8s.allanshomelab.com

  tasks:
    - name: Write an ingress for the Traefik dashboard.
      ansible.builtin.template:
        src: "gitops-traefik-dashboard-ingress.yaml.j2"
        dest: "{{ item.dest }}"
      vars: 
        gitops_traefik_host: "{{ item.host }}"
      with_items:
        - dest: "../model/traefik/nonprod/gitops-traefik-dashboard-ingress.yaml"
          host: "traefik.nonprod.allanshomelab.com"
