---
- name: Generate k8s manifests for Traefik.
  hosts: localhost
  become: no
  gather_facts: no
  vars:
    gitops_file_url: "https://raw.githubusercontent.com/traefik/traefik/v3.3/docs/content/reference/dynamic-configuration/kubernetes-crd-definition-v1.yml"
    gitops_helm_repo_name: "traefik"
    gitops_helm_repo_url: "https://traefik.github.io/charts"
    gitops_helm_chart_ref: "traefik/traefik"
    gitops_helm_chart_version: "34.3.0"
    gitops_service_name: "traefik"
    gitops_helm_namespace: "traefik"

  roles:
    # Start from scratch
    - role: gitops-clean-output
      vars:
        gitops_output_dir: "../model/traefik/nonprod/"
    - role: gitops-clean-output
      vars:
        gitops_output_dir: "../model/traefik/production/"
    # Write manifests from the Helm chart
    - role: gitops-helm-template
      vars:
        gitops_traefik_load_balancer_ip: "192.168.86.49"
        gitops_output_dir: "../model/traefik/nonprod/"
        gitops_temp_values_location: "/tmp/gitops-homelab/traefik/nonprod"
        gitops_helm_value_files:
          - template: "gitops-traefik-values.yaml.j2"
            dest: "{{ gitops_temp_values_location }}/gitops-traefik-values.yaml"
    # Separately write manifests for CRDs.
    - role: gitops-static-yaml
      vars:
        gitops_output_dir: "../model/traefik/nonprod/"
        gitops_file_dest: "gitops-crds-traefik.yaml"

  tasks:
    - name: Write a manifest for the ingress for the Traefik dashboard.
      ansible.builtin.template:
        src: "gitops-traefik-ingress-dashboard.yaml.j2"
        dest: "../model/traefik/nonprod/gitops-traefik-ingress-dashboard.yaml"
      vars:
        gitops_traefik_host: "traefik.nonprod.allanshomelab.com"

    - name: Write a manifest for the custom Traefik middleware.
      ansible.builtin.template:
        src: "gitops-traefik-middleware-custom.yaml.j2"
        dest: "../model/traefik/nonprod/gitops-traefik-middleware-custom.yaml"
