---
- name: Clone the GitOps Homelab repo.
  ansible.builtin.git:
    repo: "https://github.com/allan-lewis/gitops-homelab.git"
    dest: "{{ ansible_env.HOME }}/gitops-homelab"

- name: Clone the dotfiles repo.
  ansible.builtin.git:
    repo: "https://github.com/allan-lewis/dotfiles.git"
    dest: "{{ ansible_env.HOME }}/dotfiles"

- name: Check if Doppler is already logged in
  command: "doppler configure get token"
  register: doppler_token
  ignore_errors: yes
  changed_when: false

- name: Display current Doppler login status
  debug:
    msg: "Doppler is already logged in with a token."
  when: doppler_token.rc == 0 and doppler_token.stdout | length > 0

- name: Log in to Doppler (if not logged in)
  command: "doppler login --token {{ doppler_service_token }}"
  environment:
    DOPPLER_TOKEN: "{{ doppler_service_token }}"
  no_log: true  # Hide sensitive token output
  when: doppler_token.rc != 0 or doppler_token.stdout | length == 0
