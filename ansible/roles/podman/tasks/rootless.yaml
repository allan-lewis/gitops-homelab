---
- name: Ensure user exists
  tags: [step3_rootless]
  ansible.builtin.user:
    name: "{{ item }}"
    state: present
  loop: "{{ podman_users }}"

- name: Ensure subuid range
  tags: [step3_rootless]
  ansible.builtin.lineinfile:
    path: /etc/subuid
    create: true
    mode: "0644"
    line: "{{ item }}:100000:65536"
    regexp: "^{{ item }}:"
  loop: "{{ podman_users }}"

- name: Ensure subgid range
  tags: [step3_rootless]
  ansible.builtin.lineinfile:
    path: /etc/subgid
    create: true
    mode: "0644"
    line: "{{ item }}:100000:65536"
    regexp: "^{{ item }}:"
  loop: "{{ podman_users }}"

- name: Check if lingering is enabled
  ansible.builtin.stat:
    path: "/var/lib/systemd/linger/{{ item }}"
  register: linger_file
  loop: "{{ podman_users }}"

- name: Enable systemd lingering if not already
  ansible.builtin.command: "loginctl enable-linger {{ item.item }}"
  when: not item.stat.exists
  loop: "{{ linger_file.results }}"

- name: Ensure user containers config dir
  tags: [step3_rootless]
  ansible.builtin.file:
    path: "/home/{{ item }}/.config/containers"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0755"
  loop: "{{ podman_users }}"

# Inline registries.conf (user-level)
- name: Write user registries.conf
  tags: [step3_rootless]
  ansible.builtin.copy:
    dest: "/home/{{ item }}/.config/containers/registries.conf"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0644"
    content: |
      # User-level overrides, falls back to /etc/containers/registries.conf
      unqualified-search-registries = [{{ default_registries | map('to_json') | join(', ') }}]
  loop: "{{ podman_users }}"

# Inline storage.conf (user-level) â€” no runroot set; Podman infers /run/user/$UID/containers
- name: Write user storage.conf (fuse-overlayfs)
  tags: [step3_rootless]
  ansible.builtin.copy:
    dest: "/home/{{ item }}/.config/containers/storage.conf"
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0644"
    content: |
      [storage]
      driver = "overlay"
      graphroot = "/home/{{ item }}/.local/share/containers/storage"

      [storage.options]
      mount_program = "/usr/bin/fuse-overlayfs"

      [storage.options.overlay]
      mountopt = "nodev,metacopy=on"
  loop: "{{ podman_users }}"

- name: Ensure /run/user/$UID exists (idempotent)
  tags: [step3_rootless]
  ansible.builtin.shell: |
    set -e
    uid="$(id -u {{ item }})"
    install -d -m 0700 -o {{ item }} -g {{ item }} "/run/user/${uid}"
  args:
    executable: /bin/bash
  loop: "{{ podman_users }}"
