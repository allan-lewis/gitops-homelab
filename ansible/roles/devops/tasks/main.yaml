---
- name: Create the Ansible config directory.
  file:
    path: "{{ ansible_env.HOME }}/.config/ansible"
    state: directory
    mode: "0755"

- name: Write the Ansible config file.
  template:
    src: ansible.cfg.j2
    dest: "{{ ansible_env.HOME }}/.config/ansible/ansible.cfg"

- name: Clone the GitOps Homelab repo.
  ansible.builtin.git:
    repo: "git@github.com:allan-lewis/gitops-homelab.git"
    dest: "{{ ansible_env.HOME }}/gitops-homelab"

- name: Install the Tailscale Ansible role.
  shell: "ansible-galaxy role install artis3n.tailscale"

- name: Comment out invalid "end_role" task in artis3n.tailscale role
  become: false
  lineinfile:
    path: "{{ ansible_user_dir }}/.ansible/roles/artis3n.tailscale/tasks/main.yml"
    regexp: '^\s*- name: "Warning: Role migrated into Collection"'
    line: '# - name: "Warning: Role migrated into Collection"'
    state: present
    backrefs: yes

- name: Comment out the deprecated "end_role" block in artis3n.tailscale
  become: false
  blockinfile:
    path: "{{ ansible_user_dir }}/.ansible/roles/artis3n.tailscale/tasks/main.yml"
    marker: "# {mark} ANSIBLE PATCH: comment out deprecated end_role block"
    block: |
      # - name: "Warning: Role migrated into Collection"
      #   ansible.builtin.meta: end_role
      #   delegate_to: localhost
      #   run_once: true
      #   when: "('This standalone role has been migrated into a collection.\n\nPlease review the collection and plan a drop-in migration.\nThis role will eventually be archived. A notice period will be communicated.\n\nhttps://github.com/artis3n/ansible-collection-tailscale' | print_warn())"

