---
- name: Create the Ansible config directory.
  file:
    path: "{{ ansible_env.HOME }}/.config/ansible"
    state: directory
    mode: "0755"

- name: Write the Ansible config file.
  template:
    src: ansible.cfg.j2
    dest: "{{ ansible_env.HOME }}/.config/ansible/ansible.cfg"

- name: Clone the GitOps Homelab repo.
  ansible.builtin.git:
    repo: "git@github.com:allan-lewis/gitops-homelab.git"
    dest: "{{ ansible_env.HOME }}/gitops-homelab"

- name: Install the Tailscale Ansible role.
  shell: "ansible-galaxy role install artis3n.tailscale"

- name: Disable the "migrated into a collection" task by overriding its when clause
  ansible.builtin.replace:
    path: "{{ ansible_user_dir }}/.ansible/roles/artis3n.tailscale/tasks/main.yml"
    regexp: '^(\s*)when:.*migrated into a collection.*$'
    replace: '\1when: false'

- name: Check that the task has been patched.
  shell: grep 'when:' {{ ansible_user_dir }}/.ansible/roles/artis3n.tailscale/tasks/main.yml } | grep migrated || echo "already disabled"
  register: patch_status

- debug:
    var: patch_status.stdout
