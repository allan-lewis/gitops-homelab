---
- name: Check if systemd-resolved config exists
  stat:
    path: /etc/systemd/resolved.conf
  register: resolved_conf

- name: Set DNSStubListener=no (disable stub listener)
  lineinfile:
    path: /etc/systemd/resolved.conf
    regexp: '^#?DNSStubListener='
    line: 'DNSStubListener=no'
    create: false
    backup: yes
  register: resolved_line
  when: resolved_conf.stat.exists

- name: Point /etc/resolv.conf to external resolver temporarily
  copy:
    dest: /etc/resolv.conf
    content: |
      nameserver 1.1.1.1
      nameserver 9.9.9.9
    owner: root
    group: root
    mode: "0644"
  when: resolved_conf.stat.exists

- name: Restart systemd-resolved immediately (only if config changed)
  systemd:
    name: systemd-resolved
    state: restarted
  when:
    - resolved_conf.stat.exists
    - resolved_line is changed
