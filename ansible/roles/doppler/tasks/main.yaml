---
- name: Check if Doppler is already logged in
  command: "doppler whoami"
  register: doppler_whoami
  ignore_errors: yes
  no_log: true
  changed_when: false

- name: Display current Doppler login status
  debug:
    msg: "Doppler is already logged in with a token."
  when: doppler_whoami.rc == 0 

- name: Log in to Doppler (if not logged in)
  command: "doppler login --token {{ doppler_service_token }}"
  environment:
    DOPPLER_TOKEN: "{{ doppler_service_token }}"
  no_log: true  # Hide sensitive token output
  when: doppler_whoami.rc != 0
