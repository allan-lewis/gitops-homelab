---
- name: Generate k8s manifests for Cert Manager.
  hosts: localhost
  become: no
  gather_facts: no
  vars:
    gitops_file_url: "https://github.com/cert-manager/cert-manager/releases/download/v1.17.0/cert-manager.yaml"
    gitops_file_dest: "gitops-k8s-cert-manager-install.yaml"

  roles:
    - role: gitops-get-file
      vars:
        gitops_output_dir: "../model/cert-manager/nonprod/"
    - role: gitops-get-file
      vars:
        gitops_output_dir: "../model/cert-manager/production/"

  tasks:
    - name: Write the cluster issuer for Cert Manager
      ansible.builtin.template:
        src: "gitops-k8s-cert-manager-cluster-issuer.yaml.j2"
        dest: "{{ item }}"
      with_items:
        - "../model/cert-manager/nonprod/gitops-k8s-cert-manager-cluster-issuer.yaml"
        - "../model/cert-manager/production/gitops-k8s-cert-manager-cluster-issuer.yaml"

    - name: Write the certificate for Cert Manager.
      ansible.builtin.template:
        src: "gitops-k8s-cert-manager-certificate.yaml.j2"
        dest: "{{ item.dest }}"
      vars:
        cert_manager_common_name: "{{ item.common_name }}"
        cert_manager_dns_names: "{{ item.dns_names }}"
      with_items: 
        - dest: "../model/cert-manager/nonprod/gitops-k8s-cert-manager-certificate.yaml"
          common_name: "traefik.nonprod.allanshomelab.com"
          dns_names:
            - "traefik.nonprod.allanshomelab.com"
            - "longhorn.nonprod.allanshomelab.com"
            - "cloud.nonprod.allanshomelab.com"
            - "auth.nonprod.allanshomelab.com"
            - "nginx.nonprod.allanshomelab.com"
            - "wiki.nonprod.allanshomelab.com"
            - "argocd.nonprod.allanshomelab.com"
            - "tools.nonprod.allanshomelab.com"
            - "*.nonprodhosts.allanshomelab.com"

