---
- name: install gatus
  hosts: docker_gatus
  become: yes
  gather_facts: yes
  tags: [docker_gatus]

  roles:
    - role: docker_compose
      vars:
        compose_app_name: gatus
        compose_source_type: template
        compose_template_src: "templates/docker-compose/gatus.compose.yaml.j2"
        compose_extra_templates:
          - src: "templates/docker-compose/gatus.config.yaml.j2"
            dest: "/etc/gatus/config.yaml"
            uid: 1000
            gid: 1000
        compose_paths:
          - path: "/var/lib/gatus"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"
          - path: "/etc/gatus"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

  post_tasks:
    - name: setup backup fragments for gatus
      include_tasks: "playbooks/includes/backup_fragments.yaml"
      vars:
        backup_known_hosts: ['procyon']
        backup_fragments:
          - name: "docker-gatus.conf"
            header: "gatus config and data"
            pairs:
              - { src: "/etc/gatus",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/gatus/config" }
              - { src: "/var/lib/gatus",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/gatus/data" }

- name: install immich
  hosts: docker_immich
  become: yes
  gather_facts: yes
  tags: [docker_immich]

  roles:
    - role: docker_compose
      vars:
        compose_app_name: immich
        compose_immich_version: "v2.3.1"

        # Use the vendor compose from the exact release tag
        compose_source_type: url
        compose_url: "https://github.com/immich-app/immich/releases/download/{{ compose_immich_version }}/docker-compose.yml"

        # Everything here is auto-validated (undefined/empty => fail early)
        compose_env:
          IMMICH_VERSION: "{{ compose_immich_version }}"
          UPLOAD_LOCATION: "/mnt/immich"
          DB_DATA_LOCATION: "/srv/immich/postgres"  
          REDIS_DATA_LOCATION: "/srv/immich/redis"
          MODEL_CACHE_LOCATION: "/srv/immich/model-cache"
          COMPOSE_PROJECT_NAME: "immich"
          DB_USERNAME: "postgres"
          DB_DATABASE_NAME: "immich"
          DB_PASSWORD: "{{ lookup('env', 'IMMICH_DB_PASSWORD') }}"

        compose_paths:
          # NFS uploads (do not chown from client; role will verify it's NFS-mounted)
          - path: "/mnt/immich"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/immich"
            nfs_opts: "rw"

          # Postgres data (local; container will chown on first init)
          - path: "/srv/immich/postgres"
            create: true
            mode: "0755"

          # Redis data (local; volatile)
          - path: "/srv/immich/redis"
            create: true
            mode: "0755"

          # Model cache (local; volatile) â€” leave root-owned
          - path: "/srv/immich/model-cache"
            create: true
            mode: "0755"
    - role: postgres_db_backup
      vars:
        postgres_db_container: immich_postgres
        postgres_db_name: "immich"
        postgres_db_user: "postgres"
        postgres_db_password: "{{ lookup('env', 'IMMICH_DB_PASSWORD') }}"

  post_tasks:
    - name: setup backup fragments for immich
      include_tasks: "playbooks/includes/backup_fragments.yaml"
      vars:
        backup_known_hosts: ['procyon']
        backup_fragments:
          - name: "docker-immich.conf"
            header: "immich: postgres volume + dumps (skip NFS uploads, redis, model-cache)"
            pairs:
              - { src: "/srv/immich/postgres",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/immich/postgres-volume" }
              - { src: "{{ postgres_db_backup_dir }}",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/immich/db-dumps" }

- name: install pi-hole
  hosts: docker_pihole
  become: yes
  gather_facts: yes
  tags: [docker_pihole]

  roles:
    - role: pihole_pre
    - role: docker_compose
      vars:    
        compose_app_name: pihole
        compose_source_type: template
        compose_template_src: "templates/docker-compose/pihole.compose.yaml.j2"
        compose_paths:
          - path: "/var/lib/pihole"
            create: true
            mode: "0755"
    - role: pihole_post
    - role: pihole_dns

  post_tasks:
    - name: setup backup fragments for traefik
      include_tasks: "playbooks/includes/backup_fragments.yaml"
      vars:
        backup_known_hosts: ['procyon']
        backup_fragments:
          - name: "docker-pihole.conf"
            header: "pihole config and data"
            pairs:
              - { src: "/var/lib/pihole",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/pihole/data" }

- name: install jellyfin
  hosts: docker_jellyfin
  become: yes
  gather_facts: yes
  tags: [docker_jellyfin]

  roles:
    - role: docker_compose
      vars:   
        compose_app_name: jellyfin
        compose_source_type: template
        compose_template_src: templates/docker-compose/jellyfin.compose.yaml.j2

        compose_env:
          JELLYFIN_PUBLISHED_URL: "https://jellyfin.media.allanshomelab.com"
          JELLYFIN_USER_UID: "1000"
          JELLYFIN_GROUP_GID: "1000"

        compose_paths:
          - path: "/srv/jellyfin/config"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

          - path: "/srv/jellyfin/cache"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

          - path: "/mnt/media-library"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/media-library"
            nfs_opts: "ro"

  post_tasks:
    - name: setup backup fragments for jellyfin
      include_tasks: "playbooks/includes/backup_fragments.yaml"
      vars:
        backup_known_hosts: ['procyon']
        backup_fragments:
          - name: "docker-jellyfin.conf"
            header: "jellyfin config (exclude cache and NFS media library)"
            pairs:
              - { src: "/srv/jellyfin/config",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/jellyfin/config" }

- name: install plex
  hosts: docker_plex
  become: yes
  gather_facts: yes
  tags: [docker_plex]

  roles:
    - role: docker_compose
      vars:  
        compose_app_name: plex
        compose_source_type: template
        compose_template_src: templates/docker-compose/plex.compose.yaml.j2

        compose_env:
          PLEX_TZ: "{{ gitops_tz }}"
          PLEX_PUID: 1000
          PLEX_PGID: 1000

        compose_paths:
          - path: "/srv/plex/config"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

          - path: "/srv/plex/transcode"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

          - path: "/mnt/media-library"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/media-library"
            nfs_opts: "ro"

  post_tasks:
    - name: setup backup fragments for plex
      include_tasks: "playbooks/includes/backup_fragments.yaml"
      vars:
        backup_known_hosts: ['procyon']
        backup_fragments:
          - name: "docker-plex.conf"
            header: "plex config (skip NFS media and transcode)"
            pairs:
              - { src: "/srv/plex/config",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/plex/config" }

- name: install tautulli
  hosts: docker_tautulli
  become: yes
  gather_facts: yes
  tags: [docker_tautulli]

  roles:
    - role: docker_compose
      vars:  
        compose_app_name: tautulli
        compose_source_type: template
        compose_template_src: templates/docker-compose/tautulli.compose.yaml.j2

        compose_paths:
          - path: "/etc/tautulli"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

  post_tasks:
    - name: setup backup fragments for tautulli
      include_tasks: "playbooks/includes/backup_fragments.yaml"
      vars:
        backup_known_hosts: ['procyon']
        backup_fragments:
          - name: "docker-tautulli.conf"
            header: "tautulli config"
            pairs:
              - { src: "/etc/tautulli",
                  dest: "allan@{{ hostvars['procyon'].ansible_host }}:/mnt/pool1/gitops-homelab/backup-runner/{{ inventory_hostname }}/tautulli/config" }

- name: install twingate
  hosts: docker_twingate
  become: yes
  gather_facts: yes
  tags: [docker_twingate]

  roles:
    - role: docker_compose
      vars:
        compose_app_name: twingate
        compose_source_type: template
        compose_template_src: "templates/docker-compose/twingate.compose.yaml.j2"
        compose_env:
          TWINGATE_NETWORK_NAME: "allanshomelab"
          VALIANT_STINGRAY_ACCESS_TOKEN: "{{ lookup('env', 'TWINGATE_VALIANT_STINGRAY_ACCESS_TOKEN') }}"
          VALIANT_STINGRAY_REFRESH_TOKEN: "{{ lookup('env', 'TWINGATE_VALIANT_STINGRAY_REFRESH_TOKEN') }}"
