---
- name: Setup monitoring on all Docker hosts
  hosts: docker
  become: yes
  gather_facts: yes
  tags: [docker_monitoring]

  roles:
    - role: docker_compose
      # Declare vars here since the host group is docker, which might have additional compose tasks
      vars:
        compose_app_name: monitoring
        compose_source_type: template
        compose_template_src: "templates/docker-compose/monitoring.compose.yaml.j2"

- name: Setup Gatus
  hosts: docker_gatus
  become: yes
  gather_facts: yes
  tags: [docker_gatus]

  roles:
    - role: docker_compose
      vars:
        compose_app_name: gatus
        compose_source_type: template
        compose_template_src: "templates/docker-compose/gatus.compose.yaml.j2"
        compose_extra_templates:
          - src: "templates/docker-compose/gatus.config.yaml.j2"
            dest: "/etc/gatus/config.yaml"
            uid: 1000
            gid: 1000
        compose_paths:
          - path: "/var/lib/gatus"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"
          - path: "/etc/gatus"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

- name: Setup Traefik
  hosts: docker_traefik
  become: yes
  gather_facts: yes
  tags: [docker_traefik]

  roles:
    - role: docker_compose
      vars:
        compose_app_name: traefik
        compose_source_type: template
        compose_template_src: "templates/docker-compose/traefik.compose.yaml.j2"
        compose_env:
          CLOUDFLARE_EMAIL: "allan.e.lewis@gmail.com"
          CLOUDFLARE_API_KEY: "{{ lookup('env', 'TRAEFIK_CF_API_KEY') }}"
        compose_extra_templates:
          - src: "templates/docker-compose/traefik.config.yaml.j2"
            dest: "/etc/traefik/traefik.yaml"
            uid: 1000
            gid: 1000
        compose_paths:
          - path: "/var/lib/traefik/acme"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"
          - path: "/etc/traefik"
            create: true
            uid: 1000
            gid: 1000
            mode: "0755"

- name: Setup Immich
  hosts: docker_immich
  become: yes
  gather_facts: yes
  tags: [docker_immich]

  roles:
    - role: docker_compose
      vars:
        compose_app_name: immich
        compose_immich_version: "v2.1.0"

        # Use the vendor compose from the exact release tag
        compose_source_type: url
        compose_url: "https://github.com/immich-app/immich/releases/download/{{ compose_immich_version }}/docker-compose.yml"

        # Everything here is auto-validated (undefined/empty => fail early)
        compose_env:
          IMMICH_VERSION: "{{ compose_immich_version }}"
          UPLOAD_LOCATION: "/mnt/immich"
          DB_DATA_LOCATION: "/srv/immich/postgres"  
          REDIS_DATA_LOCATION: "/srv/immich/redis"
          MODEL_CACHE_LOCATION: "/srv/immich/model-cache"
          COMPOSE_PROJECT_NAME: "immich"
          DB_USERNAME: "postgres"
          DB_DATABASE_NAME: "immich"
          DB_PASSWORD: "{{ lookup('env', 'IMMICH_DB_PASSWORD') }}"

        compose_paths:
          # NFS uploads (do not chown from client; role will verify it's NFS-mounted)
          - path: "/mnt/immich"
            create: false
            mode: "0755"
            nfs: true
            nfs_server: "{{ hostvars['procyon'].ansible_host }}"
            nfs_path: "/mnt/pool1/immich"
            nfs_opts: "rw,sync,hard,intr"

          # Postgres data (local; container will chown on first init)
          - path: "/srv/immich/postgres"
            create: true
            mode: "0755"

          # Redis data (local; volatile)
          - path: "/srv/immich/redis"
            create: true
            mode: "0755"

          # Model cache (local; volatile) â€” leave root-owned
          - path: "/srv/immich/model-cache"
            create: true
            mode: "0755"
