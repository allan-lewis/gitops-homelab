---
units:
  - name: node-exporter
    type: service
    content: |
      [Unit]
      Description=Node Exporter (Podman, native)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Restart=always
      ExecStartPre=-/usr/bin/podman rm -f node-exporter
      ExecStart=/usr/bin/podman run --name node-exporter --replace \
        -p 9100:9100 \
        -v /proc:/host/proc:ro \
        -v /sys:/host/sys:ro \
        -v /:/rootfs:ro \
        quay.io/prometheus/node-exporter:v1.9.1 \
        --path.rootfs=/host \
        --path.procfs=/host/proc \
        --path.sysfs=/host/sys \
        --collector.filesystem.ignored-mount-points \
        ^/(sys|proc|dev|host|etc|rootfs/var/lib/containers|rootfs/run/containers)($$|/)
      ExecStop=/usr/bin/podman stop -t 10 node-exporter
      TimeoutStopSec=30

      [Install]
      WantedBy=default.target

  - name: cadvisor
    type: service
    content: |
      [Unit]
      Description=cAdvisor (Podman, native)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Restart=always
      ExecStartPre=-/usr/bin/podman rm -f cadvisor
      ExecStart=/usr/bin/podman run --name cadvisor --replace \
        -p 32800:8080 \
        -v /:/rootfs:ro \
        -v /sys:/sys:ro \
        -v /sys/fs/cgroup:/sys/fs/cgroup:ro \
        gcr.io/cadvisor/cadvisor:v0.52.1
      ExecStop=/usr/bin/podman stop -t 10 cadvisor
      TimeoutStopSec=30

      [Install]
      WantedBy=default.target

  - name: homelab-metrics
    type: service
    content: |
      [Unit]
      Description=Homelab Metrics (Podman, native)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Restart=always
      ExecStartPre=-/usr/bin/podman rm -f homelab-metrics
      ExecStart=/usr/bin/podman run --name homelab-metrics --replace \
        --userns=keep-id \
        -p 9102:9102 \
        {{ ('-e FORWARD_METRICS_URL=' ~ homelab_metrics_forward_url ~ ' ') if (homelab_metrics_forward_url is defined and homelab_metrics_forward_url | length > 0) else '' }}\
        allanelewis/homelab-metrics:latest
      ExecStop=/usr/bin/podman stop -t 10 homelab-metrics
      TimeoutStopSec=30

      [Install]
      WantedBy=default.target
