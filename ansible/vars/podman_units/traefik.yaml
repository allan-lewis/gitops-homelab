---
# Host paths for Traefik state & dynamic config (adjust if needed)
traefik_letsencrypt_dir: "/home/lab/apps/traefik/letsencrypt"
traefik_config_dir: "/home/lab/apps/traefik/config"

# Ensure these exist via your podman_prepare role
paths:
  - "{{ traefik_letsencrypt_dir }}"
  - "{{ traefik_config_dir }}"

units:
  - name: traefik
    type: service
    content: |
      [Unit]
      Description=Traefik v3 (Podman, rootless)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Restart=always
      ExecStartPre=-/usr/bin/podman rm -f traefik
      ExecStart=/usr/bin/podman run --name traefik --replace \
        --userns=keep-id \
        --cap-add=CAP_NET_BIND_SERVICE \
        --network pasta \
        -p 80:80 \
        -p 443:443 \
        -p 8088:8080 \
        -v {{ traefik_letsencrypt_dir }}:/letsencrypt \
        -v {{ traefik_config_dir }}:/traefik \
        {{ ('-e CF_API_EMAIL=' ~ homelab_cloudflare_email ~ ' ') if (homelab_cloudflare_email is defined and homelab_cloudflare_email | length > 0) else '' }}\
        {{ ('-e CF_API_KEY=' ~ homelab_cloudflare_api_key ~ ' ') if (homelab_cloudflare_api_key is defined and homelab_cloudflare_api_key | length > 0) else '' }}\
        traefik:v3.5.3 \
          --api.insecure=true \
          --providers.file.directory=/traefik/ \
          --providers.file.watch=true \
          --entryPoints.web.address=:80 \
          --entryPoints.websecure.address=:443 \
          --certificatesresolvers.myresolver.acme.dnschallenge=true \
          --certificatesresolvers.myresolver.acme.dnschallenge.provider=cloudflare \
          --certificatesresolvers.myresolver.acme.email=allan.e.lewis@gmail.com \
          --certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json \
          --serversTransport.insecureSkipVerify=true
      ExecStop=/usr/bin/podman stop -t 10 traefik
      TimeoutStopSec=30

      [Install]
      WantedBy=default.target

  - name: whoami
    type: service
    content: |
      [Unit]
      Description=traefik/whoami (Podman, rootless)
      After=network-online.target
      Wants=network-online.target

      [Service]
      Restart=always
      ExecStartPre=-/usr/bin/podman rm -f whoami
      ExecStart=/usr/bin/podman run --name whoami --replace \
        --userns=keep-id \
        --cap-add=CAP_NET_BIND_SERVICE \
        -p 8180:80 \
        traefik/whoami:latest
      ExecStop=/usr/bin/podman stop -t 10 whoami
      TimeoutStopSec=30

      [Install]
      WantedBy=default.target
